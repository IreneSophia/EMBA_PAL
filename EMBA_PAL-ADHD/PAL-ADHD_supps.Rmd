---
title: "Supplementary materials"
subtitle: 'Bayesian Brain in ADHD: potential catecholaminergic
pathway of volatility estimation'
author: "Plank et al."
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    number_sections: true
    latex_engine: xelatex
fontsize: 9pt
geometry: margin=0.5in
header-includes:
# Add the S before section and table numbers
- \renewcommand{\thesection}{S\arabic{section}}
- \renewcommand{\thetable}{S\arabic{table}} 
---

```{r setup, include=FALSE}

# clear global environment
rm(list=ls())

knitr::opts_chunk$set(echo = T, fig.pos = "center",
                      fig.width = 7.5, fig.height = 4, 
                      echo=FALSE, message=F, warning=F)

ls.packages = c("knitr",# kable
    "ggplot2",          # plots
    "brms",             # Bayesian lmms
    "designr",          # simLMM
    "bridgesampling",   # bridge_sampler
    "tidyverse",        # tibble stuff
    "ggpubr",           # ggarrange
    "ggrain",           # geom_rain
    "bayesplot",        # plots for posterior predictive checks
    "SBC",              # plots for checking computational faithfulness
    "rstatix",          # anova
    "BayesFactor", 
    "effectsize",
    "bayestestR"        # equivalence_test
)

lapply(ls.packages, library, character.only=TRUE)

# Setup caching of results
brms_dir = "./_brms_models"

# confidence interval functions
lower_ci = function(var) {
  unname(quantile(var, probs = 0.025))
}
upper_ci = function(var) {
  unname(quantile(var, probs = 0.975))
}

# scale function for vector
scale_this = function(x){
  (x - mean(x, na.rm=TRUE)) / sd(x, na.rm=TRUE)
}

# graph settings 
c_light = "#a9afb2"; c_light_highlight = "#8ea5b2"; c_mid = "#6b98b2" 
c_mid_highlight = "#3585b2"; c_dark = "#0072b2"; c_dark_highlight = "#0058b2" 
c_green = "#009E73"
sz = 1
a = 0.5

# custom colour palette
col.grp = c("#FFC107", "#004D40", "#1E88E5")
col.cnd = c("#5D3A9B", "#E66100")

# set the seed
set.seed(2468)

```

<style type="text/css">
  .main-container {
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
  }
</style>

# Package versions

The following packages are used in this RMarkdown file: 
  
```{r lib_versions, echo=F}

print(R.Version()$version.string)

for (package in ls.packages) {
  print(sprintf("%s version %s", package, packageVersion(package)))
}

```
# Methods: additional details 

## Procedure

Behavioural tasks were performed in a small, soundproof testing chamber with consistent lighting on a Lenovo Legion Pro 5 mounted in a laptop stand (resolution: 2560x1600 pixel; size: 344x215mm; refresh rate: 60Hz). Eye-tracking data was collected with a LiveTrack Lightning eye tracker (Cambridge RS, sampling rate 500Hz) using a headrest to ensure a stable viewing distance of 57cm. The eye tracker was individually calibrated before each task based on 9-points. 

## Stimulus creation

Stimuli were created using KDEF pictures of people portraying three expressions: emotionally neutral, fearful and happy (Lundqvist et al., 1998). Happy and fearful pictures were morphed with emotionally neutral pictures of the same person using WinMorph 3.01 to create videos of the person gradually and continually taking on an emotional expression. Independent samples of 21 and 25 participants rated the naturalness of videos of female-presenting and male-presenting faces, respectively (online surveys on SoSci, Leiner, 2019). We selected six identities based on these ratings (F02, F05, F09, M10, M11 and M13; naturalness of selected videos: range = 70.04-82.81; mean = 76.55). Of these videos, we extracted still images capturing 50%, 75% and 100% of the emotional expression to create hard, medium and easy stimuli, respectively. 

## Development of associations across PAL task

```{r eval1, fig.height=6}

# load the trial order
df.trl = read_csv('../data/PAL_scheme.csv', show_col_types = F) %>%
  mutate(
    association = ut*100, 
    prob_HP = prob_HP*100
  )

# create rectangles to colour the phases: prevolatile, volatile and postvolatile
rects = data.frame(xstart = c(-Inf, 72, 264), 
                   xend = c(72, 264, Inf), 
                   col = c("a", "b", "c"))
  
ggplot() +
  geom_rect(data = rects, aes(xmin = xstart, xmax = xend, 
                              ymin = -Inf, ymax = Inf, 
                              fill = col), alpha = 0.4) +
  scale_fill_manual(values=c(c_mid_highlight, c_green, c_dark_highlight), 
                    guide = "none") +
  geom_jitter(data = df.trl, 
              aes(x = trl, y = association, shape = expected),
              colour = "black", alpha = 0.8, size = 1, width = 0, height = 4) +
  geom_line(data = df.trl, 
            aes(x = trl, y = prob_HP),
            colour = "black") +
  scale_shape_manual(values = c(8, 1, 3)) +
  theme_bw() + 
  scale_y_continuous(breaks=c(16.7, 83.3)) +
  labs(x = "trial", y = "percent", 
       title = "High tone > positive, low tone > negative emotion") +
  annotate("text", x = 36, y = 125, label= "prevolatile", size = 4) +
  annotate("text", x = 168, y = 125, label= "volatile", size = 4) +
  annotate("text", x = 301, y = 125, label= "postvolatile", size = 4) +
  theme(legend.position = c(0.9, 0.5), legend.title = element_blank(), 
        legend.background = element_rect(fill = alpha("white", 0)),
        legend.key = element_rect(fill = alpha("white", 0)),
        plot.title = element_text(hjust = 0.5), text = element_text(size = 12))

```

## Computational modelling of reaction times: Hierarchical Gaussian Filter

To ensure model reliability and faithfulness, we followed the Bayesian workflow adaptation for computational modelling as proposed by Hess and colleagues (2025). This workflow includes the computation of empirical priors, in our case based on the publicly available data from Lawson et al. (2021) as well as our own pilot data, simulation-based evaluation of parameter recovery and model identifiability, posterior predictive checks and model comparison. 

## Comparison of LME across groups

```{r eval2}

aov.lme = readRDS(file.path(brms_dir, "aov_lme.rds"))
aov.lme@bayesFactor

```

## Analysis of extracted HGF parameters

We analysed HGF parameters using a Bayesian linear model with a Gaussian distribution and included group as the population-level predictor. Additionally, we explored whether ADHD diagnosis or ADHD medication could be predicted using scaled HGF parameters by fitting two Bernoulli models. For these Bernoulli models, we did not distinguish between adults with ADHD alone and those with comorbid ASD. We used a lognormal Bayesian linear mixed model to assess the influence of alpha level (second, third level), change (prevolatile to volatile, volatile to postvolatile) and their interaction on learning rate updates. The model also includes participants (level and change slopes) on the group-level. 

## Computational modelling of reaction times: Wiener Diffusion Model

We used the ggdmc package to implement a Bayesian version of a hierarchical Wiener diffusion model (Lin & Strickland, 2020), since Bayesian versions of DDM are more robust to designs with fewer trials (Myers et al., 2022). We constructed three separate hierarchical DDMs, one for each group, as a single model for all groups did not converge. Each model included one drift rate per task phase (prevolatile, volatile, postvolatile) to assess differences between task phases with high and low environmental volatility. We assessed model reliability with simulation-based parameter recovery. Only models where all potential scale reduction factors assessing convergence of the Markov chains were smaller than 1.1 were included in the analysis (Gelman et al., 2003). To achieve convergence, we increased the thinning until stable models were obtained. Then, we extracted participant-specific DDM parameters and analysed the drift rates with a Bayesian linear mixed model with a Gaussian distribution (population-level predictors group, phase and their interaction; group-level intercept for participants). A similar model focusing on adults with ADHD, regardless of comorbid ASD, investigated the influence of medication on drift rates. 

## Conventional analysis of reaction time variance, reaction times and error rates

We included only reaction times on correct trials in the analysis of the reaction times and reaction time variances. Additionally, we excluded extreme reaction times defined by the interquartile method. Participants whose accuracy was below 66.67% were excluded from all analyses. Additionally, reaction time variance was only computed as standard deviation for conditions where at least two-thirds of the trialsâ€™ reaction times were included in the analysis. We used a shifted lognormal distribution to model correct reaction times with the model including group, expectancy, phase and difficulty on the population level. On the group level, we added trials (slope for group) and participants (slopes for expectancy, phase, difficulty and their interactions). We analysed reaction time variance with a lognormal model including the population-level predictors group, expectancy, phase and their interaction as well as participants with slopes for expectancy and phase on the group-level. We dropped the predictor difficulty due to poor posterior predictive fit, slightly deviating from the preregistration. Additionally, we used a Bayesian ANOVA on the rank transformed accuracies to explore differences. 

# Participant-specific HGF and DDM parameters

## H3c: second level tonic volatility

```{r hgf1}

m = readRDS(file.path(brms_dir, "m_hgf_om2.rds"))

summary(m)

```

## Predicting ADHD diagnosis with HGF parameters

```{r hgf2}

m = readRDS(file.path(brms_dir, "m_hgf_bern_adhd.rds"))

summary(m)

```

## Predicting ADHD medication with HGF parameters

```{r hgf3}

m = readRDS(file.path(brms_dir, "m_hgf_bern_meds.rds"))

summary(m)

```

## Learning rate update

```{r hgf4}

m = readRDS(file.path(brms_dir, "m_hgf_alpha.rds"))

summary(m)

```

```{r hgf4_plot, fig.height=6}

m$data %>%
  ggplot(aes(1, value, fill = diagnosis, colour = diagnosis)) + #
  geom_rain(rain.side = 'r',
boxplot.args = list(color = "black", outlier.shape = NA, show.legend = FALSE, alpha = .8),
violin.args = list(color = "black", outlier.shape = NA, alpha = .8),
boxplot.args.pos = list(
  position = ggpp::position_dodgenudge(x = 0, width = 0.3), width = 0.3
),
point.args = list(show.legend = FALSE, alpha = .5),
violin.args.pos = list(
  width = 0.6, position = position_nudge(x = 0.16)),
point.args.pos = list(position = ggpp::position_dodgenudge(x = -0.25, width = 0.1))) +
  scale_fill_manual(values = col.grp) +
  scale_color_manual(values = col.grp) +
  facet_wrap(level ~ change, scales = "free") +
  labs(title = "Learning rate updates", x = "", y = "") +
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5), 
        legend.direction = "horizontal", text = element_text(size = 15),
        axis.text.x = element_blank(), axis.ticks.x = element_blank())

```

## Group differences in drift rate

```{r ddm}

m = readRDS(file.path(brms_dir, "m_ddm_v.rds"))

summary(m)

```

## Influence of medication on drift rate

```{r ddm2}

m = readRDS(file.path(brms_dir, "m_ddm_v3.rds"))

summary(m)

```

# Conventional analyses of responses and pupil sizes

## Response time variance

```{r var}

m = readRDS(file.path(brms_dir, "m_var.rds"))

summary(m)

```

```{r plot_var, fig.height=4}

# plot transition effects specifically
m$data %>% 
  group_by(diagnosis, phase) %>%
  summarise(
    var.mn = mean(rt.var),
    var.se = sd(rt.var) / sqrt(n())
  ) %>%
  ggplot(aes(y = var.mn, x = phase, 
             group = diagnosis, colour = diagnosis)) +
  geom_line(position = position_dodge(0.4), linewidth = 1) +
  geom_errorbar(aes(ymin = var.mn - var.se, 
                    ymax = var.mn + var.se), linewidth = 1, width = 0.5, 
                position = position_dodge(0.4)) + 
  geom_point(position = position_dodge(0.4), size = 5) + 
  labs (x = "phase", y = "rt SD (ms)") + 
  scale_fill_manual(values = col.grp) +
  scale_color_manual(values = col.grp) +
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5))

```

## Response times

```{r rt}

m = readRDS(file.path(brms_dir, "m_pal.rds"))

summary(m)

```

```{r plot_rt, fig.height=10}

m$data %>%
  ggplot(aes(diagnosis, rt.cor, fill = expected, colour = expected)) + #
  geom_rain(rain.side = 'r',
boxplot.args = list(color = "black", outlier.shape = NA, show.legend = FALSE, alpha = .8),
violin.args = list(color = "black", outlier.shape = NA, alpha = .8),
boxplot.args.pos = list(
  position = ggpp::position_dodgenudge(x = 0, width = 0.3), width = 0.3
),
point.args = list(show.legend = FALSE, alpha = .5),
violin.args.pos = list(
  width = 0.6, position = position_nudge(x = 0.16)),
point.args.pos = list(position = ggpp::position_dodgenudge(x = -0.25, width = 0.1))) +
  scale_fill_manual(values = col.cnd) +
  scale_color_manual(values = col.cnd) +
  #ylim(0, 1) +
  labs(title = "Reaction times per subject", x = "", y = "rt (ms)") +
  facet_wrap(difficulty ~ phase) +
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5), 
        legend.direction = "horizontal", text = element_text(size = 15))

```

## Pupil sizes

```{r pup}

m = readRDS(file.path(brms_dir, "m_pup.rds"))

summary(m)

```


```{r plot_pup, fig.height=3}

# rain cloud plot
m$data %>%
  group_by(subID, diagnosis, expected) %>%
  summarise(
    rel_pupil = mean(rel_pupil)
  ) %>%
  ggplot(aes(diagnosis, rel_pupil, fill = expected, colour = expected)) + #
  geom_rain(rain.side = 'r',
boxplot.args = list(color = "black", outlier.shape = NA, show.legend = FALSE, alpha = .8),
violin.args = list(color = "black", outlier.shape = NA, alpha = .8),
boxplot.args.pos = list(
  position = ggpp::position_dodgenudge(x = 0, width = 0.3), width = 0.3
),
point.args = list(show.legend = FALSE, alpha = .5),
violin.args.pos = list(
  width = 0.6, position = position_nudge(x = 0.16)),
point.args.pos = list(position = ggpp::position_dodgenudge(x = -0.25, width = 0.1))) +
  scale_fill_manual(values = col.cnd) +
  scale_color_manual(values = col.cnd) +
  labs(title = "", x = "", y = "pupil size change (mm)") +
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_blank(),
        legend.direction = "horizontal", text = element_text(size = 15), 
        legend.title = element_blank())

```


## Accuracies

```{r acc}

aov.acc = readRDS(file.path(brms_dir, "aov_acc.rds"))

aov.acc@denominator

kable(aov.acc@bayesFactor %>% select(bf) %>% arrange(desc(bf)),
      digits = 2)

```


```{r plot_acc, fig.height=10}

# rain cloud plot including all factors

aov.acc@data %>%
  ggplot(aes(expected, acc, fill = diagnosis, colour = diagnosis)) + #
  geom_rain(rain.side = 'r',
boxplot.args = list(color = "black", outlier.shape = NA, show.legend = FALSE, alpha = .8),
violin.args = list(color = "black", outlier.shape = NA, alpha = .8),
boxplot.args.pos = list(
  position = ggpp::position_dodgenudge(x = 0, width = 0.3), width = 0.3
),
point.args = list(show.legend = FALSE, alpha = .5),
violin.args.pos = list(
  width = 0.6, position = position_nudge(x = 0.16)),
point.args.pos = list(position = ggpp::position_dodgenudge(x = -0.25, width = 0.1))) +
  scale_fill_manual(values = col.grp) +
  scale_color_manual(values = col.grp) +
  labs(title = "Accuracies per subject", x = "", y = "accuracy (%)") +
  facet_wrap(phase ~ difficulty) +
  theme_bw() + 
  theme(legend.position = "bottom", plot.title = element_text(hjust = 0.5), 
        legend.direction = "horizontal", text = element_text(size = 15))

```

